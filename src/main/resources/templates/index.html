<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Manage Products</title>
    <!-- BootStrap ê³¼ JQuery ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ê°€ì ¸ì˜¨ë‹¤ -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>
</head>
<body>
<div class="container mt-4">
    <div class="d-flex justify-content-between mb-3">
        <h2>Manage Products</h2>
        <div>
            <button class="btn btn-danger" id="deleteSelected">Delete</button>
            <button class="btn btn-success" id="addProduct">Add New Product</button>
        </div>
    </div>
    <!-- Products Table -->
    <table class="table table-striped">
        <!-- table header -->
        <thead class="thead-dark">
        <tr>
            <th><input type="checkbox" id="selectAll"></th>
            <th>Name</th>
            <th>Price</th>
            <th>Image URL</th>
            <th>Actions</th>
        </tr>
        </thead>
        <!-- jQuery ì—ì„œ table idë¥¼ ì‚¬ìš©ì„ ìœ„í•´  <tbody id="productTableBody" th:each="product : ${products}"> -->
        <!-- ì—ì„œ th:each ë¥¼ tbody ì™€ ë¶„ë¦¬í•˜ì˜€ë‹¤ -->
        <!-- th:data-id : trì— id="" ì™€ ê°™ì´ data-id=1 ê°’ì„ ì£¼ì… í•´ì¤Œ -->
        <tbody id="productTableBody">
        <tr th:each="product : ${products}" th:data-id="${product.id}">
            <td><input type="checkbox" class="productCheckbox"></td>
            <td th:text="${product.name}"></td>
            <td th:text="${product.price}"></td>
            <td th:text="${product.imageUrl}"></td>
            <td>
                <button class="btn btn-warning btn-sm editProduct">âœï¸</button>
                <button class="btn btn-danger btn-sm deleteProduct">ğŸ—‘ï¸</button>
            </td>
        </tr>
        </tbody>
    </table>
</div>

<!-- Product Modal -->
<div class="modal fade" id="productModal" tabindex="-1" role="dialog" aria-labelledby="productModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="productModalLabel">Add New Product</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <!-- form ì„ í†µí•´ POST, PUT api ìš”ì²­ì„ ë³´ë‚¸ë‹¤ -->
                <form id="productForm">
                    <input type="hidden" id="productId" name="id">
                    <div class="form-group">
                        <label for="productName">Name</label>
                        <input type="text" class="form-control" id="productName" name="name" required>
                    </div>
                    <div class="form-group">
                        <label for="productPrice">Price</label>
                        <input type="number" class="form-control" id="productPrice" name="price" required>
                    </div>
                    <div class="form-group">
                        <label for="productImageUrl">Image URL</label>
                        <input type="text" class="form-control" id="productImageUrl" name="imageUrl" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="saveProduct">Save changes</button>
            </div>
        </div>
    </div>
</div>

<script>
    $(document).ready(function () {
        // API ì—”ë“œí¬ì¸íŠ¸ ê¸°ë³¸ URL
        const apiBaseUrl = '/api/products';

        // ì œí’ˆ ëª©ë¡ì„ ì„œë²„ì—ì„œ ê°€ì ¸ì™€ì„œ í…Œì´ë¸”ì— í‘œì‹œí•˜ëŠ” í•¨ìˆ˜
        function loadProducts() {
            $.get(apiBaseUrl, function (response) {
                // í…Œì´ë¸” ë³¸ë¬¸ì„ ë¹„ìš°ê¸°
                $('#productTableBody').empty();

                // products ë°ì´í„°ë¡œ í…Œì´ë¸” í–‰ ìƒì„±
                response.data.forEach(product => {
                    $('#productTableBody').append(`
                        <tr data-id="${product.id}">
                            <td><input type="checkbox" class="productCheckbox"></td>
                            <td>${product.name}</td>
                            <td>${product.price}</td>
                            <td>${product.imageUrl}</td>
                            <td>
                                <button class="btn btn-warning btn-sm editProduct">âœï¸</button>
                                <button class="btn btn-danger btn-sm deleteProduct">ğŸ—‘ï¸</button>
                            </td>
                        </tr>
                    `);
                });
            });
        }

        // "Add New Product" ë²„íŠ¼ í´ë¦­ ì‹œ ëª¨ë‹¬ì„ ì—´ê³  í¼ ì´ˆê¸°í™”
        $('#addProduct').click(function () {
            // modal title ì§€ì •
            $('#productModalLabel').text('Add New Product');

            // productForm ì„ ì§€ì •
            // jQuery ê°ì²´ëŠ” ë°°ì—´ í˜•íƒœë¡œ ë°˜í™˜ë˜ê¸° ë•Œë¬¸ì—, ìˆœìˆ˜ DOM ìš”ì†Œë¥¼ ì„ íƒí•˜ê¸° ìœ„í•´ ë°°ì—´ì˜ ì²« ë²ˆì§¸ ìš”ì†Œë¥¼ ì„ íƒ
            // í¼ ë‚´ì˜ ëª¨ë“  ì…ë ¥ í•„ë“œë¥¼ ì´ˆê¸°í™”
            $('#productForm')[0].reset();

            // hidden í•„ë“œê°’ì¸ id ì œê±°
            $('#productId').val('');

            // close ë¡œ ë˜ì–´ ìˆë˜ modal ì†ì„±ì„ show ë¡œ ìˆ˜ì •
            $('#productModal').modal('show');
        });

        // "Save changes" ë²„íŠ¼ í´ë¦­ ì‹œ í¼ ë°ì´í„°ë¥¼ ì„œë²„ë¡œ ì „ì†¡í•˜ì—¬ ì €ì¥
        $('#saveProduct').click(function () {
            const productData = {
                name: $('#productName').val(),
                price: $('#productPrice').val(),
                imageUrl: $('#productImageUrl').val()
            };
            const productId = $('#productId').val();

            //
            const ajaxOptions = {
                url: apiBaseUrl,
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(productData),
                success: function () {
                    $('#productModal').modal('hide');
                    loadProducts();
                }
            };

            // ë§Œì•½ ì•„ì´ë”” ê°’ì´ ì¡´ì¬í•œë‹¤ë©´ => ê¸°ì¡´ ê°ì²´ë¥¼ ìˆ˜ì •
            // ë”°ë¼ì„œ url ê³¼ methodë¥¼ PUTì— ë§ê²Œ ìˆ˜ì •í•´ì¤€ë‹¤
            if (productId) {
                ajaxOptions.url = apiBaseUrl + '/' + productId;
                ajaxOptions.type = 'PUT';
            }

            $.ajax(ajaxOptions);
        });


        // "Edit" ë²„íŠ¼ í´ë¦­ ì‹œ í•´ë‹¹ ì œí’ˆ ë°ì´í„°ë¥¼ ê°€ì ¸ì™€ ëª¨ë‹¬ì— í‘œì‹œ
        $(document).on('click', '.editProduct', function () {
            const productId = $(this).closest('tr').data('id');
            $.get(apiBaseUrl + '/' + productId, function (response) {
                $('#productModalLabel').text('Edit Product');
                $('#productId').val(response.data.id);
                $('#productName').val(response.data.name);
                $('#productPrice').val(response.data.price);
                $('#productImageUrl').val(response.data.imageUrl);
                $('#productModal').modal('show');
            });
        });

        // "Delete" ë²„íŠ¼ í´ë¦­ ì‹œ í•´ë‹¹ ì œí’ˆ ì‚­ì œ
        $(document).on('click', '.deleteProduct', function () {
            const productId = $(this).closest('tr').data('id');
            $.ajax({
                url: apiBaseUrl + '/' + productId,
                type: 'DELETE',
                success: function () {
                    loadProducts();
                }
            });
        });

        // ì„ íƒëœ ëª¨ë“  ì œí’ˆ ì¼ê´„ ì‚­ì œ
        $('#deleteSelected').click(function () {
            $('.productCheckbox:checked').each(function () {
                const productId = $(this).closest('tr').data('id');
                $.ajax({
                    url: apiBaseUrl + '/' + productId,
                    type: 'DELETE',
                    success: function () {
                        loadProducts();
                    }
                });
            });
        });

        // "Select All" ì²´í¬ë°•ìŠ¤ í´ë¦­ ì‹œ ëª¨ë“  ì œí’ˆ ì²´í¬ë°•ìŠ¤ë¥¼ ì„ íƒ ë˜ëŠ” í•´ì œ
        $('#selectAll').click(function () {
            $('.productCheckbox').prop('checked', this.checked);
        });

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì œí’ˆ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ê¸°
        loadProducts();
    });
</script>
</body>
</html>
